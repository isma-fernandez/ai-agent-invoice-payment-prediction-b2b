services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ismael
      POSTGRES_PASSWORD: ismael
      POSTGRES_DB: memory
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init.sql:/docker-entrypoint-initdb.d/init.sql

  memory-mcp-server:
    build:
      context: .
      dockerfile: docker/memory_mcp/Dockerfile
    ports:
      - "8100:8100"
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=ismael
      - POSTGRES_PASSWORD=ismael
      - POSTGRES_DB=memory
    depends_on:
      - postgres

  prediction-mcp-server:
    build:
      context: .
      dockerfile: docker/prediction_mcp/Dockerfile
    ports:
      - "8200:8200"

  # Agentes
  orchestrator:
    build:
      context: .
      dockerfile: docker/agents/Dockerfile
    ports:
      - "8004:8004"
    environment:
      - AGENT_TYPE=orchestrator
      - ODOO_URL=${ODOO_URL}
      - ODOO_DB=${ODOO_DB}
      - ODOO_USERNAME=${ODOO_USERNAME}
      - ODOO_PASSWORD=${ODOO_PASSWORD}
      - API_MISTRAL_KEY=${API_MISTRAL_KEY}
      - A2A_DATA_AGENT_URL=http://data-agent:8001
      - A2A_ANALYSIS_AGENT_URL=http://analysis-agent:8002
      - A2A_MEMORY_AGENT_URL=http://memory-agent:8003
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGCHAIN_ENDPOINT=${LANGCHAIN_ENDPOINT:-https://api.smith.langchain.com}
    depends_on:
      - data-agent
      - analysis-agent
      - memory-agent

  data-agent:
    build:
      context: .
      dockerfile: docker/agents/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - AGENT_TYPE=data_agent
      - ODOO_URL=${ODOO_URL}
      - ODOO_DB=${ODOO_DB}
      - ODOO_USERNAME=${ODOO_USERNAME}
      - ODOO_PASSWORD=${ODOO_PASSWORD}
      - API_MISTRAL_KEY=${API_MISTRAL_KEY}
      - A2A_DATA_AGENT_URL=http://data-agent:8001

  analysis-agent:
    build:
      context: .
      dockerfile: docker/agents/Dockerfile
    ports:
      - "8002:8002"
    environment:
      - AGENT_TYPE=analysis_agent
      - ODOO_URL=${ODOO_URL}
      - ODOO_DB=${ODOO_DB}
      - ODOO_USERNAME=${ODOO_USERNAME}
      - ODOO_PASSWORD=${ODOO_PASSWORD}
      - API_MISTRAL_KEY=${API_MISTRAL_KEY}
      - MCP_PREDICTION_URL=http://prediction-mcp-server:8200/mcp
      - A2A_ANALYSIS_AGENT_URL=http://analysis-agent:8002
    depends_on:
      - prediction-mcp-server

  memory-agent:
    build:
      context: .
      dockerfile: docker/agents/Dockerfile
    ports:
      - "8003:8003"
    environment:
      - AGENT_TYPE=memory_agent
      - API_MISTRAL_KEY=${API_MISTRAL_KEY}
      - MCP_MEMORY_URL=http://memory-mcp-server:8100/mcp
      - A2A_MEMORY_AGENT_URL=http://memory-agent:8003
    depends_on:
      - memory-mcp-server

volumes:
  postgres_data: